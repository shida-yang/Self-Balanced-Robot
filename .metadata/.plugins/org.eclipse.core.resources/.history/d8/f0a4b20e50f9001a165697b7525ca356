/*
 * HC_05_Bluetooth.c
 *
 *  Created on: Sep 17, 2020
 *      Author: syang
 */

// Communicate with the HC-05 Bluetooth module using SCIA
#include "HC_05_Bluetooth.h"

char BT_RX_BUF1[32];
char BT_RX_BUF2[32];

char BT_TX_BUF1[32];
char BT_TX_BUF2[32];

void HC_05_init(){
    HC_05_GPIO_init();
    HC_05_SCI_init();
}

void HC_05_read_string(char* data_str){

}

void HC_05_send_string(char* data_str){

}

__interrupt void HC_05_RX_ISR(void){

}

__interrupt void HC_05_TX_ISR(void){

}

// GPIO8 = SCITXDA(O)
// GPIO9 = SCIRXDA(I)
// GPIO10 = HC-05 EN (O)
// GPIO11 = HC-05 STATE (I)
static void HC_05_GPIO_init(){
    // enable pullups
    GpioCtrlRegs.GPAPUD.bit.GPIO8 = 0;
    GpioCtrlRegs.GPAPUD.bit.GPIO9 = 0;
    GpioCtrlRegs.GPAPUD.bit.GPIO10 = 0;
    GpioCtrlRegs.GPAPUD.bit.GPIO11 = 0;

    // GPIO8 = SCITXDA(O)
    // GPIO9 = SCIRXDA(I)
    GpioCtrlRegs.GPAGMUX1.bit.GPIO8 = 1;
    GpioCtrlRegs.GPAGMUX1.bit.GPIO9 = 1;
    GpioCtrlRegs.GPAMUX1.bit.GPIO8 = 2;
    GpioCtrlRegs.GPAMUX1.bit.GPIO9 = 2;

    // asynch qual
    GpioCtrlRegs.GPAQSEL1.bit.GPIO9 = 3;
    GpioCtrlRegs.GPAQSEL1.bit.GPIO11 = 3;

    // direction of EN and STATE
    GpioCtrlRegs.GPADIR.bit.GPIO10 = 1;
    GpioCtrlRegs.GPADIR.bit.GPIO11 = 0;
}

static void HC_05_SCI_init(){
    SciaRegs.SCICTL1.bit.SWRESET = 0;

    // set BAUD rate to 9600 (doc page 2184)
    SciaRegs.SCILBAUD.all = 650 & 0xFF;
    SciaRegs.SCIHBAUD.all = 650 >> 8;

    // 8 data bit, 1 stop bit, no parity
    SciaRegs.SCICCR.bit.SCICHAR = 7;
    SciaRegs.SCICCR.bit.STOPBITS = 0;
    SciaRegs.SCICCR.bit.PARITYENA = 0;

    // allow SCI to complete current transfer if hits breakpoint
    SciaRegs.SCIPRI.bit.FREESOFT = 1;

    // enable receive interrupt
    SciaRegs.SCICTL2.bit.RXBKINTENA = 1;
    Interrupt_register(INT_SCIA_RX, &HC_05_RX_ISR);
    Interrupt_enable(INT_SCIA_RX);

    // enable transmit interrupt
    SciaRegs.SCICTL2.bit.TXINTENA = 1;
    Interrupt_register(INT_SCIA_TX, &HC_05_TX_ISR);
    Interrupt_enable(INT_SCIA_TX);

    // enable TX and RX
    SciaRegs.SCICTL1.bit.TXENA = 1;
    SciaRegs.SCICTL1.bit.RXENA = 1;

    // end software reset
    SciaRegs.SCICTL1.bit.SWRESET = 1;
}

static char HC_05_read_byte(){
    return SciaRegs.SCIRXBUF.all;
}

static void HC_05_send_byte(char data){
    SciaRegs.SCITXBUF.all = data;
}
